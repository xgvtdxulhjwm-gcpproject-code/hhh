
name: Linux NoVNC (Panel)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 265
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Desktop Environment
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tigervnc-standalone-server python3-websockify curl htop neofetch
        git clone --depth 1 https://github.com/novnc/noVNC.git
    
    - name: Start VNC + noVNC
      run: |
        mkdir -p ~/.vnc
        echo "Vps@nFa2qNKj@6" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        vncserver :1 -geometry 1920x1080 -depth 24
        ./noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 6080 &
        sleep 5
        
    - name: Setup Cloudflared
      run: |
        curl -L --output cloudflared-linux-amd64.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb || true
        cloudflared tunnel --url http://localhost:6080 --no-autoupdate > tunnel.log 2>&1 &
        sleep 25

    - name: Export Info
      run: |
        for i in {1..45}; do
          URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' tunnel.log | head -n 1)
          if [ -n "$URL" ]; then
            echo "$URL/vnc.html|Vps@nFa2qNKj@6" > info.txt
            break
          fi
          sleep 2
        done
        if [ ! -f info.txt ]; then
          echo "ERROR|Tunnel not found" > info.txt
        fi

    - name: Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: result
        path: info.txt
        retention-days: 1

    - name: Keep Alive
      run: |
        echo "VPS running"
        for i in $(seq 1 240); do
          sleep 60
        done
